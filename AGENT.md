Запуск Frame
============
В **обычной командной строке** выполнить команды:
```
cd frame
npm run alpha
```
Активировать нужный Ethereum-аккаунт.


Запуск IPFS
===========
В отдельном окне командной строки **Linux**:
```
aragon ipfs
```

Работа с Agent через Aragon CLI
===============================
Работаем в отдельном окне командной строки **Linux**.
Рассмотрены примеры с Compound.finance.

При первом вызове Aragon CLI может выдать ошибку - тогда в окне Frame может потребоваться разрешить Aragon CLI работать с Frame (кнопка Approve)

Загрузка файла с переменными
----------------------------

В папке, в которой мы находимся при работе с командной строкой Linux, желательно разместить файл с набором переменных, чтобы не приходилось копипастить нужные адреса.
Кроме того, это снижает вероятность ошибки.

Файл может иметь вид (например, `env-marsdao-mainnet.sh`):
```
#!/bin/sh

dao=mars-dao.eth
agent=0x0a74D136fAfed0F8d58ce4b7307283695EC7A0B6
flags="--env aragon:mainnet --use-frame"
eth=0x0000000000000000000000000000000000000000
zrx=0xe41d2489571d322189246dafa5ebde1f4699f498
dai=0x89d24a6b4ccb1b6faa2625fe562bdd9a23260359
c_zrx=0xb3319f5d18bc0d84dd1b4825dcde5d5f7266d407
c_dai=0xf5dce57282a584d2746faf1593d3121fcac444dc
# and so on...
```

Следите за актуальностью адресов, дополняйте по необходимости.
Файл можно быстро подредактировать "на месте" через `nano env-marsdao-mainnet.sh`
Ctrl-X - выход из редактора с вопросом о сохранении.

Если файл менялся, перезагружали комп или командную строку - переменные из файла втягиваются через
`source env-marsdao-mainnet.sh`
или
`. ./env-marsdao-mainnet.sh` (точка пробел точка слеш ... - это сокращенная форма)

Подгрузка файла с переменными через HTTP(S)
-------------------------------------------

Если файл размещен на https://pastebin.com/raw/YkjAgCfr то его можно сходу подгрузить так:

```
source <(curl https://pastebin.com/raw/YkjAgCfr | egrep -vh '^\s*$')
```
**Важно: такие подгрузки проводить только по ссылкам, полученным из доверенных источников и c серверов, насчет которых нет сомнений в их "чистоте". Крайне рекомендуется изучать содержимое лично на отстутствие вредноносных конструкций. Команды, содержащиеся в удаленном файле, вышеприведенная команда немедленно выполнит пачкой в командной строке. Лучше вообще размещать на своих серверах, а еще лучше - грузить с локального компьютера и не пользоваться удаленными подгрузками. Компромис между "удобством" и надежностью определяйте сами.**

После этого можно работать с Aragon CLI.

Compound v2 (Presidio)
======================

Все суммы указываются в неделимых единицах.
Для Ether - в wei, т.е. для 1 ether = 1000000000000000000.
Для ERC-20 Token XYZ с 18 digits, 1 xyz = 1000000000000000000.

Approve (app.compound.finance: Enable)
--------------------------------------------------

Разрешение контракту Compound на снятие токенов с баланса Agent не более определеннай суммы. Для эфира Approve не нужен. Вызовы рассмотрены на примере cDAI.
```
dao $flags act $agent $dai 'approve(address,uint256)' $c_dai <сумма>
```
Функция Enable в app.compound.finance делает сумму максимальной, т.е. достаточно 1 раз вызвать Approve и больше об этом не вспоминать.
**С другой стороны, мы расписываемся в том, что доверяем коду смарт-контракта Compound, и верим в отсуствие в нем уязвимостей, позволяющих злоумышленнику снять с нашего баланса токены от имени Compound на свое усмотрение.**

Неограниченный Approve можно сделать так:
```
dao $flags act $agent $dai 'approve(address,uint256)' $c_dai $ffff
```

Отмена Approve. Кнопки "Disable" в app.compound.finance нет, но запретить контрактам Compound доступ к токенам агента все же можно. Так:

```
dao $flags act $agent $dai 'approve(address,uint256)' $c_dai 0
```

Mint (в app и v1 протокола - Supply)
------------------------------------
Сумма указываемтся в неделимых оригинальных токенах (ETH, DAI etc).
У cEther и сErc20 вызываются по-разному.
Для cEther (нужна патченная версия Aragon CLI).

Отдать 1.234 DAI в обмен на cDAI:
```
dao $flags act $agent $c_dai 'mint(uint256)' 1234000000000000000
```
Отдать 1.234 ETH в обмен на cETH:
```
dao $flags act $agent $c_eth 'mint()' --value 1234000000000000000
```

Redeem (app/v1: Withdraw)
-------------------------
Сумма указываемтся в неделимых Compound-токенах (cETH, cDAI etc).
Выкупить DAI обратно за 1.234 cDAI (cDAI has 8 digits):
```
dao $flags act $agent $c_dai 'redeem(uint256)' 123400000
```

Redeem Underlying
-----------------
Сумма указываемтся в неделимых оригинальных токенах (ETH, DAI etc).
Выкупить 1.234 DAI обратно за cDAI:
```
dao $flags act $agent $c_dai 'redeemUnderlying(uint256)' 1234000000000000000
```

Enter/exit market (app: Enable Borrow)
-------------------------------------

В документации сказано, что в Compound v2 расчет показателей Collateral Factor проводится независимо для каждого рынка, и пользователи должны активировать функцию Enter market для каждого отдельного cToken для того, чтобы система счтиала доступный объем занимаемых средств.

Вызов надо сделать всего 1 раз, но не будет ошибкой повторные вызовы с иными наборами cTokens. Ниже показано, как сделать Enter Market для cDAI, cETH и cZRX:
```
dao $flags act $agent $comp 'enterMarkets(address[])' "[\"$c_zrx\",\"$c_dai\",\"$c_eth\"]"
```
*Внимание на последний параметр: внешние двойные кавычки нормальные, внутренние - все префиксованы слешем.*

Borrow
------
Сумма указываемтся в неделимых оригинальных токенах (ETH, DAI etc).
Одолжить 1.234 DAI 
```
dao $flags act $agent $c_dai 'borrow(uint256)' 1234000000000000000
```

Repay Borrow
------------
Сумма указываемтся в неделимых оригинальных токенах (ETH, DAI etc).
У cEther и сErc20 вызываются по-разному.
Вернуть долг 1.234 DAI:
```
dao $flags act $agent $c_dai 'repayBorrow(uint256)' 1234000000000000000
```
Вернуть долг 1.234 ETH:
```
dao $flags act $agent $c_eth 'repayBorrow()' --value 1234000000000000000
```

Сумму надо указывать целым числом в неделимых единицах.
Если у DAI 18 после запятой - то для перевода 1 DAI надо 1000000000000000000 указывать.

Uniswap Exchange Protocol
=========================

Во всех командах Uniswap указывается deadline - время, после которого транзакция не будет выполненной. Это связано с тем, что между подписанием транзакции и ее майнингом могут пройти различные интервалы времени, в течении которых могут меняться курсы, и этот интервал может затянуться на невыгодные/непредсказуемые/недопустимые для вызывающего интервалы. Этот параметр задается в виде Unix Timestamp и зависит от текущего времени, и поэтому постоянно изменяется. Для его рассчета "на ходу" можно использовать команду `date` и возможность арифметических вычислений в bash (командной строке Linux). Так `$(date +%s)` выдаст нам текущий timestamp, а для указания deadline как "не далее чем час (3600 секунд) после текущего момента" - 
```
$[$(date +%s)+3600]
```
(внимание на обязательный пробел перед первым плюсом)


Add Liquidity
-------------
Добавление стейка ликвидности в 1.234 ETH / 6.789 MRQ с дедлайном 3600 секунд с текущего момента, и требованием получения как минимум 0 токенов ликвидности:
```
dao $flags act $agent $u_mrq 'addLiquidity(uint256,uint256,uint256)' 0 6789000000000000000 $[$(date +%s)+3600] --value 1234000000000000000
```

Remove Liquidity
----------------
Изъятие стейка ликвидности в 4.5 токенов ликвидности и минимум 1.234 ETH / 6.789 MRQ
с дедлайном 3600 секунд с текущего момента:
```
dao $flags act $agent $u_mrq 'removeLiquidity(uint256,uint256,uint256,uint256)' 4500000000000000000 1234000000000000000 6789000000000000000 $[$(date +%s)+3600] --value
```

ETH > ERC20 Swap Input
----------------------
Обмен строго 1.234 ETH на минимум 6.789 MRQ с явным указанием количества продаваемых ETH
с дедлайном 3600 секунд с текущего момента
(минимум MRQ указывается в качестве ограничителя неприемлемого курса):
```
dao $flags act $agent $u_mrq 'ethToTokenSwapInput(uint256,uint256)' 6789000000000000000 $[$(date +%s)+3600] --value 1234000000000000000
```

ETH > ERC20 Swap Output
-----------------------
Обмен максимум 1.234 ETH на строго 6.789 MRQ с явным указанием количества покупаемых MRQ
с дедлайном 3600 секунд с текущего момента
(максимум ETH указывается в качестве ограничителя неприемлемого курса):
```
dao $flags act $agent $u_mrq 'ethToTokenSwapOutput(uint256,uint256)' 6789000000000000000 $[$(date +%s)+3600] --value 1234000000000000000
```

ERC20 > ETH Swap Input
----------------------
Обмен строго 1.234 MRQ на минимум 6.789 ETH с явным указанием количества продаваемых MRQ
с дедлайном 3600 секунд с текущего момента
(минимум MRQ указывается в качестве ограничителя неприемлемого курса):
```
dao $flags act $agent $u_mrq 'tokenToEthSwapInput(uint256,uint256,uint256)' 1234000000000000000 6789000000000000000 $[$(date +%s)+3600]
```

ERC20 > ETH Swap Output
-----------------------
Обмен максимум 1.234 MRQ на строго 6.789 ETH с явным указанием количества покупаемых ETH
с дедлайном 3600 секунд с текущего момента
(максимум ETH указывается в качестве ограничителя неприемлемого курса):
```
dao $flags act $agent $u_mrq 'tokenToEthSwapOutput(uint256,uint256)' 6789000000000000000 1234000000000000000 $[$(date +%s)+3600]
```
